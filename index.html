<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rizz â€” Screenshot â†’ Rizz</title>

<!-- Tesseract.js CDN (client-side OCR) -->
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
  :root{--bg:#05060a;--card:#0f1720;--muted:#9aa4b2;--accent:#00d38a;--pill:#111827}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  h1{margin:0 0 10px;font-size:28px}
  .top {display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .drop{flex:1;padding:14px;border-radius:12px;background:var(--card);border:1px dashed #23303a;min-height:84px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  input[type=file]{display:none}
  button{padding:10px 14px;border-radius:10px;border:none;background:#e6f7ee;color:#00331a;font-weight:700;cursor:pointer}
  .small{padding:8px 10px;background:#111827;color:#fff;border-radius:8px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .panel{background:var(--card);padding:14px;border-radius:12px;min-height:160px}
  .panel h3{margin:0 0 8px;font-size:16px}
  .progress{height:8px;background:#0b1220;border-radius:8px;overflow:hidden;margin:8px 0}
  .progFill{height:100%;background:linear-gradient(90deg,var(--accent),#00ffa3);width:0}
  pre{white-space:pre-wrap;word-break:break-word;color:#e6eef2}
  .match{background:#12332b;padding:6px;border-radius:8px;margin:6px 0;display:inline-block}
  .replyBtn{background:#fff;color:#023; padding:8px 10px;border-radius:8px;font-weight:700}
  .note{color:var(--muted);font-size:13px;margin-top:8px}
  .footer{margin-top:14px;color:var(--muted);font-size:13px}
  @media(max-width:900px){ .grid{grid-template-columns:1fr; } .panel{min-height:120px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Rizz â€” Screenshot â†’ Rizz</h1>

  <div class="top">
    <label class="drop" id="dropZone">
      <input id="fileInput" type="file" accept="image/*" />
      <div id="dropText">Click or drag & drop a screenshot (WhatsApp/Chat)</div>
    </label>

    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="ocrBtn">Run OCR</button>
      <button id="clearBtn" class="small">Clear OCR</button>
      <button id="openRizz" class="small">Open Rizz Dashboard</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="leftPanel">
      <h3>Screenshot preview & OCR</h3>
      <div id="previewArea" style="display:flex;flex-direction:column;gap:8px">
        <div id="imgWrap" style="display:none">
          <img id="previewImg" src="" style="max-width:100%;border-radius:8px;display:block" />
        </div>

        <div class="progress" style="display:none" id="progressBar">
          <div class="progFill" id="progFill"></div>
        </div>

        <div id="ocrText" style="margin-top:8px"><pre id="ocrPre">No OCR run yet.</pre></div>
      </div>
      <div class="note">Note: OCR runs locally in your browser using Tesseract.js. First run may take a few seconds.</div>
    </div>

    <div class="panel" id="rightPanel">
      <h3>Parsed data & actions</h3>

      <div id="parsedArea">
        <div id="namesArea"><strong>Detected names:</strong><div id="namesList" style="margin-top:8px"></div></div>
        <div style="margin-top:10px">
          <strong>Detected timestamps / times:</strong>
          <div id="timesList" style="margin-top:6px"></div>
        </div>

        <div style="margin-top:12px">
          <strong>Suggested reply templates</strong>
          <div id="replySuggestions" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:12px">
          <strong>Actions</strong>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="addToRizz" class="small">Add to Rizz</button>
            <button id="openChat" class="small">Open quick reply (copy)</button>
            <button id="saveShot" class="small">Save screenshot (local)</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <strong>Matched Rizz people</strong>
          <div id="matchedPeople" style="margin-top:8px"></div>
        </div>
      </div>

      <div style="margin-top:12px" class="note">
        Export/Import removed per request. All data is stored in your browser localStorage (Rizz people + screenshot metadata).
      </div>
    </div>
  </div>

  <div class="footer">Tip: use clear OCR to process another screenshot. For best results crop to the chat area.</div>
</div>

<script>
/* ---------- Simple Screenshot â†’ Rizz SPA ---------- 
   - OCR: Tesseract.js (client-side)
   - parse: simple regex heuristics for names and timestamps
   - storage: localStorage under "rizz_v2_people" and "rizz_v2_screenshots"
   - actions: add person to Rizz, copy suggested reply
*/

// Local store keys
const PEOPLE_KEY = 'rizz_v2_people';
const SHOTS_KEY  = 'rizz_v2_shots';

// DOM
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const ocrBtn = document.getElementById('ocrBtn');
const clearBtn = document.getElementById('clearBtn');
const previewImg = document.getElementById('previewImg');
const imgWrap = document.getElementById('imgWrap');
const progressBar = document.getElementById('progressBar');
const progFill = document.getElementById('progFill');
const ocrPre = document.getElementById('ocrPre');

const namesList = document.getElementById('namesList');
const timesList = document.getElementById('timesList');
const replySuggestions = document.getElementById('replySuggestions');
const matchedPeople = document.getElementById('matchedPeople');

const addToRizzBtn = document.getElementById('addToRizz');
const openChatBtn = document.getElementById('openChat');
const saveShotBtn = document.getElementById('saveShot');
const openRizzBtn = document.getElementById('openRizz');

let currentImageData = null;
let ocrText = '';
let parsed = { names: [], times: [], messages: [] };

// Helpers: local store
function loadPeople(){ try { return JSON.parse(localStorage.getItem(PEOPLE_KEY) || '[]'); } catch(e){ return []; } }
function savePeople(arr){ localStorage.setItem(PEOPLE_KEY, JSON.stringify(arr)); }
function loadShots(){ try { return JSON.parse(localStorage.getItem(SHOTS_KEY) || '[]'); } catch(e){ return []; } }
function saveShots(arr){ localStorage.setItem(SHOTS_KEY, JSON.stringify(arr)); }

// Basic parser heuristics (WhatsApp-like)
function parseOCR(text){
  // simple split lines and look for "Name â€” time" like patterns or "12:34 â€¢ Yesterday" etc.
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const names = new Set();
  const times = new Set();
  const messages = [];

  const timeRegex = /(?:\b[0-2]?\d[:.][0-5]\d\b|\b(?:yesterday|today|ago|am|pm|AM|PM)\b|[0-3]?\d\/[0-1]?\d\/\d{2,4})/i;
  const nameLineRegex = /^([A-Z][a-z]{1,20})(?::| - | â€” | Â· |ï¼š)/; // "John: message", "John - msg"

  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    // detect "Name: message" style
    const mname = line.match(nameLineRegex);
    if(mname) {
      names.add(mname[1]);
      messages.push(line);
      continue;
    }
    // detect time patterns
    const mt = line.match(timeRegex);
    if(mt) {
      times.add(mt[0]);
      // include following line as message maybe
      if(lines[i+1]) messages.push(lines[i+1]);
      continue;
    }
    // fallback: short lines that look like names (capitalized single word)
    if (/^[A-Z][a-z]{1,20}$/.test(line)) {
      names.add(line);
      continue;
    }
    // otherwise store as message content
    messages.push(line);
  }

  return {
    names: Array.from(names),
    times: Array.from(times),
    messages
  };
}

// OCR run (Tesseract)
async function runOCRFromData(imgDataURL){
  ocrPre.textContent = 'Running OCR...';
  progressBar.style.display = 'block';
  progFill.style.width = '0%';
  ocrText = '';
  parsed = { names: [], times: [], messages: [] };

  try {
    const worker = Tesseract.createWorker({
      logger: m => {
        if(m.status === 'recognizing text' && m.progress) {
          progFill.style.width = Math.round(m.progress * 100) + '%';
        }
      }
    });
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    const { data } = await worker.recognize(imgDataURL);
    ocrText = data.text || '';
    await worker.terminate();
  } catch (e) {
    ocrText = 'OCR failed: ' + (e && e.message ? e.message : String(e));
  } finally {
    progressBar.style.display = 'none';
    progFill.style.width = '0%';
    ocrPre.textContent = ocrText || '(no text found)';
    parsed = parseOCR(ocrText);
    renderParsed(parsed);
  }
}

// Render parsed results & suggestions
function renderParsed(parsed){
  namesList.innerHTML = parsed.names.length ? parsed.names.map(n => `<span class="match">${escapeHtml(n)}</span>`).join(' ') : '<span class="muted">No clear names detected</span>';
  timesList.innerHTML = parsed.times.length ? parsed.times.map(t => `<div class="match">${escapeHtml(t)}</div>`).join(' ') : '<span class="muted">No clear times</span>';
  // suggestions
  replySuggestions.innerHTML = '';
  const suggestions = generateReplies(parsed);
  suggestions.forEach(s => {
    const b = document.createElement('button');
    b.className = 'replyBtn';
    b.textContent = s.label;
    b.onclick = ()=> { copyToClipboard(s.text); showTemporaryNotice('Reply copied to clipboard'); };
    replySuggestions.appendChild(b);
  });

  // match existing Rizz people
  const people = loadPeople();
  const matches = people.filter(p => parsed.names.some(n => p.name.toLowerCase().includes(n.toLowerCase()) || n.toLowerCase().includes(p.name.toLowerCase())));
  matchedPeople.innerHTML = matches.length ? matches.map(mp => `<div class="match">${escapeHtml(mp.name)} â€” ${mp.score || 0}%</div>`).join('') : '<div class="muted">No matches in Rizz</div>';
}

// small helpers
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function showTemporaryNotice(txt){
  const old = banner.innerText;
  banner.style.display = 'block';
  banner.textContent = txt;
  setTimeout(()=>{ banner.textContent = old || ''; if(!old) banner.style.display = 'none'; }, 2500);
}
function copyToClipboard(text){
  navigator.clipboard?.writeText(text).catch(()=>{ /* ignore */ });
}

// generate 3 quick reply templates based on messages
function generateReplies(parsed){
  const msgText = (parsed.messages || []).join(' ').toLowerCase();
  const res = [];
  // If contains "bored" or "miss" -> send flirty/check-in
  if(/bored|miss|miss you|lonely|alone/.test(msgText)) {
    res.push({ label: 'Playful / Flirty', text: "Haha stop being bored ðŸ˜ Tell me exactly what you want and I'll make it happen." });
    res.push({ label: 'Sweet', text: "Aww I miss you too â€” tell me one thing that made you smile today ðŸ’›" });
  } else if(/good|great|nice|cool/.test(msgText)) {
    res.push({ label: 'Short / Positive', text: "Nice! Thatâ€™s dope. Howâ€™s your day otherwise?" });
    res.push({ label: 'Playful', text: "Thatâ€™s cute. You always find the best stuff ðŸ˜„" });
  } else if(/why|what|how|where/.test(msgText)) {
    res.push({ label: 'Answer & Ask', text: "Because I thought about you â€” what do you think?" });
    res.push({ label: 'Short Answer', text: "Yeah â€” Iâ€™ll handle it. Want me to come through?" });
  } else {
    res.push({ label: 'Casual', text: "I see. Tell me more ðŸ˜" });
    res.push({ label: 'Tease', text: "Youâ€™re being suspiciously quiet â€” say something interesting ðŸ˜œ" });
  }
  // generic fallback
  res.push({ label: 'Quick care', text: "Hope youâ€™re good â€” checking in ðŸ’š" });
  return res;
}

// UI interactions
dropZone.ondrop = (e)=>{
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) handleFile(f);
};
dropZone.ondragover = (e)=>{ e.preventDefault(); };

fileInput.onchange = (e) => {
  const f = e.target.files && e.target.files[0];
  if(f) handleFile(f);
};

async function handleFile(file){
  if(!file.type.startsWith('image/')) return showTemporaryNotice('Please select an image file');
  const reader = new FileReader();
  reader.onload = () => {
    currentImageData = reader.result;
    previewImg.src = currentImageData;
    imgWrap.style.display = 'block';
    ocrPre.textContent = 'Ready to OCR. Click "Run OCR"';
    parsed = { names: [], times: [], messages: [] };
    renderParsed(parsed);
  };
  reader.readAsDataURL(file);
}

ocrBtn.onclick = async ()=>{
  if(!currentImageData) return showTemporaryNotice('No image loaded');
  await runOCRFromData(currentImageData);
};

clearBtn.onclick = ()=>{
  currentImageData = null;
  previewImg.src = '';
  imgWrap.style.display = 'none';
  ocrPre.textContent = 'Cleared OCR';
  namesList.innerHTML = '';
  timesList.innerHTML = '';
  replySuggestions.innerHTML = '';
  matchedPeople.innerHTML = '';
};

addToRizzBtn.onclick = ()=>{
  // If a single name detected, add prompt; else open small prompt
  const people = loadPeople();
  if(parsed.names.length === 0){
    const want = prompt('No name auto-detected. Type the name to add to Rizz:');
    if(!want) return;
    people.push({ name: want.trim(), score: 40 });
    savePeople(people);
    showTemporaryNotice('Added ' + want);
    return;
  }
  parsed.names.forEach(n=>{
    if(!people.find(p=>p.name.toLowerCase()===n.toLowerCase())){
      people.push({ name: n, score: 40 });
    }
  });
  savePeople(people);
  showTemporaryNotice('Added detected names to Rizz');
  renderParsed(parsed);
};

openChatBtn.onclick = ()=>{
  // take first suggestion and copy to clipboard
  const sugg = generateReplies(parsed)[0];
  copyToClipboard(sugg.text);
  showTemporaryNotice('Reply copied to clipboard');
};

saveShotBtn.onclick = ()=>{
  if(!currentImageData) return showTemporaryNotice('No image to save');
  const shots = loadShots();
  shots.push({
    id: 's' + Date.now(),
    img: currentImageData,
    ocr: ocrText,
    parsed,
    createdAt: Date.now()
  });
  saveShots(shots);
  showTemporaryNotice('Screenshot saved locally');
};

openRizzBtn.onclick = ()=>{
  // navigate to the Rizz dashboard (if you have index.html in root named rizz)
  // For now show saved people
  const p = loadPeople();
  if(p.length === 0) return showTemporaryNotice('No people in Rizz (yet)');
  showTemporaryNotice(`Rizz people: ${p.map(x=>x.name).join(', ')}`);
};

// small init: load any saved people and show count
(function init(){
  const ppl = loadPeople();
  if(ppl.length) matchedPeople.innerHTML = ppl.map(pp=>`<div class="match">${escapeHtml(pp.name)} â€” ${pp.score||0}%</div>`).join('');
})();
</script>
</body>
</html>
