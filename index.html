<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ðŸ”¥ Rizz System Dashboard</title>
<style>
  :root{--bg:#000;--muted:#333;--pill:#e9eef2;--accent:#00e08a;--warn:#ffa500}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
  .wrap{padding:20px;max-width:820px;margin:0 auto}
  h1{font-size:34px;margin:0 0 12px}
  .banner{display:none;padding:12px;border-radius:12px;background:var(--warn);color:#111;margin-bottom:12px;font-weight:700}
  input[type="text"]{width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:8px;font-size:16px}
  .btn{background:var(--pill);border-radius:14px;padding:10px 14px;border:none;margin:6px 8px 6px 0;font-size:15px}
  .card{margin-bottom:26px}
  .title{display:flex;align-items:center;gap:10px}
  .title strong{font-size:18px}
  .badge{background:var(--muted);padding:5px 8px;border-radius:8px;font-size:12px}
  .badge.focus{background:var(--accent);color:#000}
  .bar{background:#222;border-radius:999px;height:14px;overflow:hidden;margin:8px 0}
  .fill{height:100%;background:var(--accent)}
  .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
  .small{padding:8px 12px;border-radius:12px;background:#f2f5f7;color:#000;font-weight:600}
  .danger{background:#ff6b6b;color:#fff}
  .muted{color:#bbb;font-size:13px}
  @media(min-width:720px){ .wrap{padding:28px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸ”¥ Rizz System Dashboard</h1>
  <div id="banner" class="banner" role="status" aria-live="polite"></div>

  <input id="nameInput" type="text" placeholder="Enter name (e.g. Charity)" />
  <div style="margin-bottom:14px;">
    <button id="addBtn" class="btn">Add / Update</button>
    <button id="clearBtn" class="btn">Clear All</button>
  </div>

  <div id="list"></div>
  <div id="info" class="muted" style="margin-top:18px;font-size:13px">
    Tip: +10/-10 clamps to 0..100. Focus limit = 2. Decay runs automatically.
  </div>
</div>

<script>
(() => {
  // Constants
  const STORAGE_KEY = 'rizz_system_v2';
  const MAX_FOCUS = 2;
  const DECAY_DAYS = 2;                 // decay threshold
  const DECAY_AMOUNT = 5;               // amount to drop after decay
  const SAVE_DEBOUNCE_MS = 600;         // batch writes to localStorage
  const DECAY_INTERVAL_MS = 60 * 60 * 1000; // run decay hourly

  // State
  let people = [];      // array of {id,name,score,status,updated,focusTime}
  let saveTimer = null;
  let bannerTimer = null;

  // Utilities
  const now = () => Date.now();
  const uid = () => `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;

  // Load
  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      people = raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('load error', e);
      people = [];
    }
  }

  // Debounced save
  function save() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(people)); }
      catch(e){ console.error('save error', e); }
    }, SAVE_DEBOUNCE_MS);
  }

  // Banner
  function showBanner(text, ms = 3500) {
    const b = document.getElementById('banner');
    b.textContent = text;
    b.style.display = 'block';
    if (bannerTimer) clearTimeout(bannerTimer);
    bannerTimer = setTimeout(() => b.style.display = 'none', ms);
  }

  // Find index by id quickly
  function findIndexById(id) {
    return people.findIndex(p => p.id === id);
  }

  // Enforce focus rules (max 2)
  function enforceFocusRules() {
    const focused = people.filter(p => p.status === 'focus');
    if (focused.length <= MAX_FOCUS) return;

    // sort by score asc, then focusTime asc (oldest first)
    focused.sort((a, b) => (a.score - b.score) || (a.focusTime - b.focusTime));
    const toDemote = focused.slice(0, focused.length - MAX_FOCUS);
    toDemote.forEach(p => {
      const idx = findIndexById(p.id);
      if (idx >= 0) {
        people[idx].status = 'active';
        people[idx].focusTime = null;
      }
    });
    showBanner('âš  Focus limit reached â€” oldest/lowest focus removed');
  }

  // Apply decay (run hourly). Only do real work if threshold passed.
  function applyDecayIfNeeded() {
    const nowMs = now();
    let changed = false;
    for (let p of people) {
      // days since last updated
      const days = (nowMs - (p.updated || nowMs)) / (1000 * 60 * 60 * 24);
      if (days >= DECAY_DAYS && p.score > 0) {
        p.score = Math.max(0, p.score - DECAY_AMOUNT);
        p.updated = nowMs;
        changed = true;
      }
    }
    if (changed) {
      save();
      render();
    }
  }

  // UI: render the list (fast via DocumentFragment)
  function render() {
    try {
      const list = document.getElementById('list');
      const frag = document.createDocumentFragment();

      // sort by score desc then updated desc for stable ordering
      const sorted = [...people].sort((a,b) => (b.score - a.score) || (b.updated - a.updated));

      sorted.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = p.id;

        // Header row
        const header = document.createElement('div');
        header.className = 'title';
        const name = document.createElement('strong');
        name.textContent = `${p.name} â€” ${p.score}%`;
        header.appendChild(name);

        const badge = document.createElement('span');
        badge.className = 'badge' + (p.status === 'focus' ? ' focus' : '');
        badge.textContent = (p.status || 'active').toUpperCase();
        header.appendChild(badge);
        card.appendChild(header);

        // Bar
        const bar = document.createElement('div');
        bar.className = 'bar';
        const fill = document.createElement('div');
        fill.className = 'fill';
        fill.style.width = `${p.score}%`;
        bar.appendChild(fill);
        card.appendChild(bar);

        // Controls (buttons via data-action)
        const controls = document.createElement('div');
        controls.className = 'controls';
        const btn = (text, action) => {
          const b = document.createElement('button');
          b.className = 'small';
          b.textContent = text;
          b.dataset.action = action;
          b.dataset.id = p.id;
          return b;
        };

        controls.appendChild(btn('-10','minus10'));
        controls.appendChild(btn('+10','plus10'));
        controls.appendChild(btn('Focus','focus'));
        controls.appendChild(btn('Pause','pause'));
        controls.appendChild(btn('Active','active'));
        controls.appendChild(btn('Delete','delete'));

        card.appendChild(controls);
        frag.appendChild(card);
      });

      // Replace children quickly
      list.innerHTML = '';
      list.appendChild(frag);
    } catch (e) {
      console.error('render error', e);
    }
  }

  // Actions from UI (delegated)
  function handleListClick(e) {
    const btn = e.target.closest('button');
    if (!btn || !btn.dataset.action) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const idx = findIndexById(id);
    if (idx < 0) return;

    try {
      const p = people[idx];
      switch(action) {
        case 'minus10':
          p.score = Math.max(0, p.score - 10);
          p.updated = now();
          break;
        case 'plus10':
          p.score = Math.min(100, p.score + 10);
          p.updated = now();
          // Auto-focus if threshold reached
          if (p.score >= 90 && p.status !== 'focus') {
            p.status = 'focus';
            p.focusTime = now();
            showBanner('âš¡ Auto-Focus: reached 90%');
          }
          break;
        case 'focus':
          p.status = 'focus';
          p.focusTime = now();
          p.updated = now();
          break;
        case 'pause':
          p.status = 'pause';
          p.updated = now();
          p.focusTime = null;
          break;
        case 'active':
          p.status = 'active';
          p.updated = now();
          p.focusTime = null;
          break;
        case 'delete':
          people.splice(idx, 1);
          break;
      }

      enforceFocusRules();
      save();
      render();
    } catch (err) {
      console.error('action error', err);
    }
  }

  // Add/update button
  function addOrUpdate() {
    const val = document.getElementById('nameInput').value.trim();
    if (!val) { showBanner('Please enter a name'); return; }

    let p = people.find(x => x.name.toLowerCase() === val.toLowerCase());
    if (p) {
      p.updated = now();
      showBanner(`Updated ${p.name}`);
    } else {
      p = { id: uid(), name: val, score: 0, status: 'active', updated: now(), focusTime: null };
      people.push(p);
      showBanner(`Added ${p.name}`);
    }
    save();
    render();
    document.getElementById('nameInput').value = '';
  }

  // Clear all (for testing)
  function clearAll() {
    if (!confirm('Clear everything?')) return;
    people = [];
    save();
    render();
  }

  // Setup
  function init() {
    load();
    // Hook events
    document.getElementById('list').addEventListener('click', handleListClick);
    document.getElementById('addBtn').addEventListener('click', addOrUpdate);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    document.getElementById('nameInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addOrUpdate();
    });

    // decay hourly
    applyDecayIfNeeded();
    setInterval(applyDecayIfNeeded, DECAY_INTERVAL_MS);

    // render initial
    enforceFocusRules();
    render();
  }

  // start
  init();
})();
</script>
</body>
</html>