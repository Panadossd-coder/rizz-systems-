<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rizz System Dashboard</title>
<style>
  :root{--bg:#000;--card:#111;--accent:#12e69a;--muted:#888;--btn:#f1f3f5}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  .wrap{max-width:900px;margin:0 auto;padding:18px;}
  h1{font-size:36px;margin:4px 0 18px;display:flex;align-items:center;gap:10px}
  .banner{background:#f7a800;color:#000;padding:12px;border-radius:10px;margin-bottom:14px;font-weight:700}
  input[type="text"]{width:100%;padding:14px;border-radius:14px;border:none;font-size:16px;background:#fff;color:#111;box-sizing:border-box}
  .controls{display:flex;gap:12px;margin:10px 0 18px;flex-wrap:wrap}
  button{background:var(--btn);border-radius:14px;padding:10px 14px;border:none;font-weight:700;cursor:pointer}
  .list{margin-top:12px}
  .item{margin-bottom:24px}
  .title{display:flex;align-items:center;gap:12px;font-size:20px;margin-bottom:8px}
  .badge{background:#333;padding:6px 10px;border-radius:8px;font-size:12px;color:#ddd}
  .focusBadge{background:var(--accent);color:#002b1d;padding:6px 10px;border-radius:8px;font-weight:700}
  .barWrap{background:#222;height:14px;border-radius:10px;overflow:hidden;position:relative;margin-bottom:10px}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#24d69b);transition:width .25s ease}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .smallBtn{padding:12px;border-radius:14px;background:#fff;color:#0d6efd;font-weight:700;border:none;cursor:pointer}
  .muted{color:var(--muted);font-size:14px;margin-top:10px}
  footer{margin-top:30px;color:#999;font-size:13px}
  @media (min-width:720px){.wrap{padding:36px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸ”¥ Rizz System Dashboard</h1>

  <div id="bannerArea"></div>

  <input id="nameIn" placeholder="Enter name (e.g. Charity)" type="text" />
  <div class="controls">
    <button id="addBtn">Add / Update</button>
    <button id="clearBtn">Clear All</button>
    <button id="decayNowBtn">Run Decay (test)</button>
  </div>

  <div id="list" class="list"></div>

  <footer>
    Tip: +10/-10 clamps to 0..100. Focus limit = 2. Decay runs every 2 days automatically.
  </footer>
</div>

<script>
/* ===== CONFIG ===== */
const STORAGE_KEY = 'rizz:data:v2';
const FOCUS_LIMIT = 2;
const AUTO_FOCUS_THRESHOLD = 90;
const DECAY_DAYS = 2;      // apply decay per this many days
const DECAY_AMOUNT = 10;   // amount to reduce per period
const DEBOUNCE_MS = 150;

/* ===== HELPERS ===== */
const now = ()=> Date.now();
const clamp = (v,min=0,max=100)=> Math.max(min, Math.min(max, Math.round(v)));
const mkId = ()=> 'id'+Math.floor(Math.random()*1e9).toString(36);
const debounce = (fn, wait=DEBOUNCE_MS)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };

function saveToStorage(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
function loadFromStorage(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ return []; } }

function showBanner(txt,ms=2200){
  const b = document.getElementById('bannerArea');
  b.innerHTML = `<div class="banner">${txt}</div>`;
  if(ms>0) setTimeout(()=>{ if(b) b.innerHTML=''; }, ms);
}

/* ===== STATE ===== */
let data = loadFromStorage(); // array of {id,name,score,status,focusedAt,lastUpdate}
function normalize(){
  data = data.map(it=>({
    id: it.id || mkId(),
    name: String(it.name || '').trim(),
    score: clamp(Number(it.score)||0),
    status: it.status || 'ACTIVE',
    focusedAt: it.focusedAt || null,
    lastUpdate: it.lastUpdate || now()
  })).filter(it=>it.name);
}

/* ===== SAVE / RENDER ===== */
function save(){ saveToStorage(data); }
function setUIEnabled(enabled){
  document.querySelectorAll('button, input').forEach(el=>{ if(el.id==='nameIn') return; el.disabled = !enabled; });
}

/* ===== Focus helpers ===== */
function getFocused(){ return data.filter(d=>d.focusedAt).sort((a,b)=>b.focusedAt - a.focusedAt); }
function ensureFocusLimit(){
  const focused = getFocused();
  if(focused.length > FOCUS_LIMIT){
    // remove oldest focusedAt entries until under limit
    const sortedAsc = [...focused].sort((a,b)=>a.focusedAt - b.focusedAt);
    const toClear = sortedAsc.slice(0, focused.length - FOCUS_LIMIT);
    toClear.forEach(it => it.focusedAt = null);
    save(); render();
    showBanner('âš ï¸ Focus limit reached â€” oldest focus removed', 2200);
  }
}

/* attempt to auto focus item when it reaches threshold */
function autoFocusIfEligible(item){
  if(!item) return;
  if(item.score >= AUTO_FOCUS_THRESHOLD && !item.focusedAt){
    item.focusedAt = now();
    item.lastUpdate = now();
    save();
    ensureFocusLimit();
    render();
    showBanner('âš¡ Auto-Focus: reached ' + AUTO_FOCUS_THRESHOLD + '%', 2200);
  }
}

/* If no focused entries, select top ones */
function autoSelectIfNone(){
  if(getFocused().length > 0) return;
  const candidates = [...data].sort((a,b)=>b.score - a.score).filter(d=>d.score>0);
  for(let i=0;i<Math.min(FOCUS_LIMIT, candidates.length); i++){
    candidates[i].focusedAt = now() - i*1000;
  }
  if(candidates.length) { save(); render(); showBanner('â„¹ï¸ No focus set â€” auto-selected top entries',2000); }
}

/* ===== DECAY =====
   For each item, compute how many DECAY_DAYS periods passed since lastUpdate,
   and subtract DECAY_AMOUNT per period. Update lastUpdate accordingly.
*/
function runDecay(){
  const nowMs = now();
  let changed = false;
  const periodMs = DECAY_DAYS * 24*3600*1000;
  data.forEach(it=>{
    const elapsed = nowMs - (it.lastUpdate || nowMs);
    const periods = Math.floor(elapsed / periodMs);
    if(periods > 0){
      it.score = clamp(it.score - periods * DECAY_AMOUNT);
      it.lastUpdate = (it.lastUpdate || nowMs) + periods * periodMs;
      changed = true;
    }
  });
  if(changed){
    save();
    // after decay, items may have crossed threshold -> auto-focus them if they do
    data.forEach(autoFocusIfEligible);
    render();
    showBanner('Decay applied', 1600);
  }
}

/* ===== CRUD & UI actions ===== */
function addOrUpdate(){
  const nameEl = document.getElementById('nameIn');
  const name = String(nameEl.value || '').trim();
  if(!name){ showBanner('Please enter a name',1800); return; }
  // find existing (case-insensitive)
  let item = data.find(d=>d.name.toLowerCase() === name.toLowerCase());
  if(item){
    item.lastUpdate = now();
    showBanner('Updated ' + item.name,1400);
  } else {
    item = { id: mkId(), name, score: 0, status: 'ACTIVE', focusedAt: null, lastUpdate: now() };
    data.push(item);
    showBanner('Added ' + item.name,1400);
  }
  nameEl.value = '';
  save(); render();
  autoSelectIfNone();
}

const safeAddOrUpdate = debounce(()=>{ setUIEnabled(false); try{ addOrUpdate(); } finally { setTimeout(()=>setUIEnabled(true),100); }}, 120);

function changeScore(id, delta){
  const it = data.find(d=>d.id===id); if(!it) return;
  it.score = clamp(it.score + delta);
  it.lastUpdate = now();
  save();
  autoFocusIfEligible(it); // ensure auto-focus if new score hits threshold
  render();
}

const safeChangeScore = (id, delta) => { setUIEnabled(false); try{ changeScore(id, delta); } finally { setTimeout(()=>setUIEnabled(true),90); } };

function setStatus(id, status){
  const it = data.find(d=>d.id===id); if(!it) return;
  it.status = status;
  if(status !== 'ACTIVE') it.focusedAt = null;
  it.lastUpdate = now();
  save(); render(); ensureFocusLimit();
}

function setFocusOn(id){
  const it = data.find(d=>d.id===id); if(!it) return;
  it.focusedAt = now();
  it.lastUpdate = now();
  save(); ensureFocusLimit(); render();
}

function unsetFocus(id){ const it = data.find(d=>d.id===id); if(!it) return; it.focusedAt = null; save(); render(); }

function removeItem(id){
  const it = data.find(d=>d.id===id); if(!it) return;
  if(!confirm(`Delete "${it.name}"?`)) return;
  data = data.filter(d=>d.id !== id);
  save(); render();
}

function clearAll(){
  if(!confirm('Clear all entries?')) return;
  data = [];
  save(); render();
}

/* ===== RENDER ===== */
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function render(){
  normalize();
  const list = document.getElementById('list');
  list.innerHTML = '';
  // sort: focused first (recent), then score desc, then name
  const sorted = [...data].sort((a,b)=>{
    const af = !!a.focusedAt, bf = !!b.focusedAt;
    if(af !== bf) return af ? -1 : 1;
    if(b.score !== a.score) return b.score - a.score;
    return a.name.localeCompare(b.name);
  });
  if(sorted.length===0){
    list.innerHTML = `<div class="muted">No entries â€” add someone to start the Rizz System.</div>`;
    return;
  }

  sorted.forEach(it=>{
    const item = document.createElement('div'); item.className = 'item';
    const title = document.createElement('div'); title.className = 'title';
    title.innerHTML = `<div style="flex:1"><strong>${escapeHtml(it.name)}</strong> â€” ${it.score}%</div>`;
    const badge = document.createElement('div'); badge.className = it.focusedAt ? 'focusBadge' : 'badge';
    badge.textContent = it.focusedAt ? 'FOCUS' : (it.status || 'ACTIVE');
    title.appendChild(badge);
    item.appendChild(title);

    const barWrap = document.createElement('div'); barWrap.className='barWrap';
    const bar = document.createElement('div'); bar.className='bar';
    bar.style.width = `${it.score}%`;
    barWrap.appendChild(bar);
    item.appendChild(barWrap);

    const row = document.createElement('div'); row.className = 'btnRow';
    const mkBtn = (txt, cb) => { const b = document.createElement('button'); b.className='smallBtn'; b.textContent=txt; b.onclick=cb; b.style.margin='6px 8px 6px 0'; return b; };

    row.appendChild(mkBtn('-10', ()=> safeChangeScore(it.id, -10)));
    row.appendChild(mkBtn('+10', ()=> safeChangeScore(it.id, +10)));
    row.appendChild(mkBtn('Focus', ()=> setFocusOn(it.id)));
    row.appendChild(mkBtn('Pause', ()=> setStatus(it.id, 'PAUSED')));
    row.appendChild(mkBtn('Active', ()=> setStatus(it.id, 'ACTIVE')));
    row.appendChild(mkBtn('Delete', ()=> removeItem(it.id)));

    item.appendChild(row);
    list.appendChild(item);
  });
}

/* ===== Wiring UI ===== */
document.getElementById('addBtn').addEventListener('click', safeAddOrUpdate);
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('decayNowBtn').addEventListener('click', ()=>{ runDecay(); });

document.getElementById('nameIn').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') safeAddOrUpdate(); });

/* ===== Boot ===== */
(function boot(){
  runDecay();    // apply decay if needed
  normalize();
  render();
  autoSelectIfNone(); // if nothing focused, auto pick top ones
})();

/* expose for quick debug in console (optional) */
window._rizz = { data, save, runDecay, render };

</script>
</body>
</html>
